<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Currency Converter</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .user-menu {
            position: relative;
            display: inline-block;
        }

        .user-menu-btn {
            display: flex;
            align-items: center;
            color: #fff;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            padding: 0.5rem;
            transition: background-color 0.2s;
        }
        
        .user-menu-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .user-menu-btn .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #4a6bea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.5rem;
            font-weight: bold;
        }

        .user-menu-btn span {
            display: inline-block !important;
            white-space: nowrap;
            opacity: 1 !important;
            visibility: visible !important;
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-width: 180px;
            z-index: 100;
            display: none;
        }

        .user-dropdown.show {
            display: block;
        }

        .user-dropdown-item {
            display: block;
            padding: 0.75rem 1rem;
            color: #333;
            text-decoration: none;
            border-bottom: 1px solid #f1f1f1;
            transition: background-color 0.2s;
        }

        .user-dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .user-dropdown-item.logout {
            color: #dc3545;
        }

        .auth-links {
            display: flex;
            gap: 1rem;
        }

        .auth-links a {
            color: #fff;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background-color 0.2s, border-color 0.2s;
        }

        .auth-links a.login {
            background-color: transparent;
            border: 1px solid #fff;
        }
        
        .auth-links a.login:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .auth-links a.register {
            background-color: #4a6bea;
        }
        
        .auth-links a.register:hover {
            background-color: #3a5bd9;
        }
        
        /* Make sure auth container has enough space */
        #auth-container {
            min-width: 120px;
            display: flex;
            justify-content: flex-end;
        }

        /* User preferences in converter */
        .user-preferences {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .preference-heading {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .save-preference-btn {
            background-color: #4a6bea;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .save-preference-btn:hover {
            background-color: #3a5bd9;
        }

        .preferences-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .preference-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .preference-item:last-child {
            border-bottom: none;
        }

        .preference-item button {
            background-color: #4a6bea;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-left: 0.25rem;
        }
        
        .preference-item .use-pair-btn {
            background-color: #28a745;
        }
        
        .preference-item .use-pair-btn:hover {
            background-color: #218838;
        }

        .preference-item .delete-pair-btn {
            background-color: #dc3545;
        }
        
        .preference-item .delete-pair-btn:hover {
            background-color: #c82333;
        }

        .login-prompt {
            margin-top: 1rem;
            text-align: center;
            padding: 1rem;
            background-color: #e9ecef;
            border-radius: 8px;
        }

        .login-prompt a {
            color: #4a6bea;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.2s;
        }
        
        .login-prompt a:hover {
            color: #3a5bd9;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="container">
            <nav class="main-nav">
                <a href="index.html" class="logo">TravelCompanion</a>
                <ul class="nav-links">
                    <li><a href="index.html" class="active">Currency Converter</a></li>
                    <li><a href="routes.html">Walking Routes</a></li>
                </ul>
                <div id="auth-container">
                    <!-- Will be populated by JavaScript -->
                </div>
            </nav>
        </div>
    </header>

    <main class="container">
        <h1>Currency Converter</h1>
        <div class="converter-section">
            <div class="converter-form">
                <input type="number" id="amount" placeholder="Enter amount" min="0" step="0.01">
                <select id="from-currency">
                    <option value="KRW">ðŸ‡°ðŸ‡· KRW - South Korean Won</option>
                    <option value="USD">ðŸ‡ºðŸ‡¸ USD - US Dollar</option>
                    <option value="EUR">ðŸ‡ªðŸ‡º EUR - Euro</option>
                    <option value="GBP">ðŸ‡¬ðŸ‡§ GBP - British Pound</option>
                    <option value="JPY">ðŸ‡¯ðŸ‡µ JPY - Japanese Yen</option>
                    <option value="CNY">ðŸ‡¨ðŸ‡³ CNY - Chinese Yuan</option>
                    <option value="INR">ðŸ‡®ðŸ‡³ INR - Indian Rupee</option>
                    <option value="AUD">ðŸ‡¦ðŸ‡º AUD - Australian Dollar</option>
                    <option value="CAD">ðŸ‡¨ðŸ‡¦ CAD - Canadian Dollar</option>
                    <option value="CHF">ðŸ‡¨ðŸ‡­ CHF - Swiss Franc</option>
                    <option value="NZD">ðŸ‡³ðŸ‡¿ NZD - New Zealand Dollar</option>
                    <option value="SGD">ðŸ‡¸ðŸ‡¬ SGD - Singapore Dollar</option>
                    <option value="HKD">ðŸ‡­ðŸ‡° HKD - Hong Kong Dollar</option>
                    <option value="SEK">ðŸ‡¸ðŸ‡ª SEK - Swedish Krona</option>
                    <option value="NOK">ðŸ‡³ðŸ‡´ NOK - Norwegian Krone</option>
                    <option value="DKK">ðŸ‡©ðŸ‡° DKK - Danish Krone</option>
                    <option value="MXN">ðŸ‡²ðŸ‡½ MXN - Mexican Peso</option>
                    <option value="BRL">ðŸ‡§ðŸ‡· BRL - Brazilian Real</option>
                    <option value="RUB">ðŸ‡·ðŸ‡º RUB - Russian Ruble</option>
                    <option value="ZAR">ðŸ‡¿ðŸ‡¦ ZAR - South African Rand</option>
                    <option value="TRY">ðŸ‡¹ðŸ‡· TRY - Turkish Lira</option>
                    <option value="THB">ðŸ‡¹ðŸ‡­ THB - Thai Baht</option>
                    <option value="MYR">ðŸ‡²ðŸ‡¾ MYR - Malaysian Ringgit</option>
                    <option value="IDR">ðŸ‡®ðŸ‡© IDR - Indonesian Rupiah</option>
                    <option value="PHP">ðŸ‡µðŸ‡­ PHP - Philippine Peso</option>
                    <option value="ILS">ðŸ‡®ðŸ‡± ILS - Israeli Shekel</option>
                    <option value="PLN">ðŸ‡µðŸ‡± PLN - Polish Zloty</option>
                    <option value="CZK">ðŸ‡¨ðŸ‡¿ CZK - Czech Koruna</option>
                    <option value="HUF">ðŸ‡­ðŸ‡º HUF - Hungarian Forint</option>
                    <option value="RON">ðŸ‡·ðŸ‡´ RON - Romanian Leu</option>
                    <option value="BGN">ðŸ‡§ðŸ‡¬ BGN - Bulgarian Lev</option>
                    <option value="HRK">ðŸ‡­ðŸ‡· HRK - Croatian Kuna</option>
                    <option value="UAH">ðŸ‡ºðŸ‡¦ UAH - Ukrainian Hryvnia</option>
                </select>
                <button id="swap-btn" class="swap-btn" title="Swap currencies">â‡„</button>
                <select id="to-currency">
                    <option value="USD">ðŸ‡ºðŸ‡¸ USD - US Dollar</option>
                    <option value="KRW">ðŸ‡°ðŸ‡· KRW - South Korean Won</option>
                    <option value="EUR">ðŸ‡ªðŸ‡º EUR - Euro</option>
                    <option value="GBP">ðŸ‡¬ðŸ‡§ GBP - British Pound</option>
                    <option value="JPY">ðŸ‡¯ðŸ‡µ JPY - Japanese Yen</option>
                    <option value="CNY">ðŸ‡¨ðŸ‡³ CNY - Chinese Yuan</option>
                    <option value="INR">ðŸ‡®ðŸ‡³ INR - Indian Rupee</option>
                    <option value="AUD">ðŸ‡¦ðŸ‡º AUD - Australian Dollar</option>
                    <option value="CAD">ðŸ‡¨ðŸ‡¦ CAD - Canadian Dollar</option>
                    <option value="CHF">ðŸ‡¨ðŸ‡­ CHF - Swiss Franc</option>
                    <option value="NZD">ðŸ‡³ðŸ‡¿ NZD - New Zealand Dollar</option>
                    <option value="SGD">ðŸ‡¸ðŸ‡¬ SGD - Singapore Dollar</option>
                    <option value="HKD">ðŸ‡­ðŸ‡° HKD - Hong Kong Dollar</option>
                    <option value="SEK">ðŸ‡¸ðŸ‡ª SEK - Swedish Krona</option>
                    <option value="NOK">ðŸ‡³ðŸ‡´ NOK - Norwegian Krone</option>
                    <option value="DKK">ðŸ‡©ðŸ‡° DKK - Danish Krone</option>
                    <option value="MXN">ðŸ‡²ðŸ‡½ MXN - Mexican Peso</option>
                    <option value="BRL">ðŸ‡§ðŸ‡· BRL - Brazilian Real</option>
                    <option value="RUB">ðŸ‡·ðŸ‡º RUB - Russian Ruble</option>
                    <option value="ZAR">ðŸ‡¿ðŸ‡¦ ZAR - South African Rand</option>
                    <option value="TRY">ðŸ‡¹ðŸ‡· TRY - Turkish Lira</option>
                    <option value="THB">ðŸ‡¹ðŸ‡­ THB - Thai Baht</option>
                    <option value="MYR">ðŸ‡²ðŸ‡¾ MYR - Malaysian Ringgit</option>
                    <option value="IDR">ðŸ‡®ðŸ‡© IDR - Indonesian Rupiah</option>
                    <option value="PHP">ðŸ‡µðŸ‡­ PHP - Philippine Peso</option>
                    <option value="ILS">ðŸ‡®ðŸ‡± ILS - Israeli Shekel</option>
                    <option value="PLN">ðŸ‡µðŸ‡± PLN - Polish Zloty</option>
                    <option value="CZK">ðŸ‡¨ðŸ‡¿ CZK - Czech Koruna</option>
                    <option value="HUF">ðŸ‡­ðŸ‡º HUF - Hungarian Forint</option>
                    <option value="RON">ðŸ‡·ðŸ‡´ RON - Romanian Leu</option>
                    <option value="BGN">ðŸ‡§ðŸ‡¬ BGN - Bulgarian Lev</option>
                    <option value="HRK">ðŸ‡­ðŸ‡· HRK - Croatian Kuna</option>
                    <option value="UAH">ðŸ‡ºðŸ‡¦ UAH - Ukrainian Hryvnia</option>
                </select>
                <button id="convert-btn">Convert</button>
            </div>
            <div id="result-display" class="result-display"></div>
            <div class="exchange-rate-info">
                <p id="exchange-rate">ðŸ‡°ðŸ‡· 1 KRW = ðŸ‡ºðŸ‡¸ 0.00076 USD</p>
                <p id="last-updated">Last updated: Just now</p>
            </div>
            <div id="loading-indicator" class="loading-indicator" style="display: none;">
                <div class="spinner"></div>
                <p>Converting...</p>
            </div>
            <div id="error-message" class="error-message"></div>

            <!-- User Preferences Section -->
            <div id="user-preferences-container">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </main>

    <footer class="app-footer">
        <div class="container">
            <p>&copy; 2025 Travel Companion App</p>
        </div>
    </footer>
    
    <script src="script.js"></script>
    <script>
        // User authentication and preferences functionality
        
        // DOM Elements
        const authContainer = document.getElementById('auth-container');
        const userPreferencesContainer = document.getElementById('user-preferences-container');
        
        // API Base URL
        const AUTH_API_BASE_URL = '/api';
        
        // Get currency flag - create reference to the function from script.js
        if (typeof getCurrencyFlag !== 'function') {
            function getCurrencyFlag(currencyCode) {
                currencyCode = currencyCode.toUpperCase();
                if (currencyCode === 'EUR') return 'ðŸ‡ªðŸ‡º';
                if (currencyCode === 'GBP') return 'ðŸ‡¬ðŸ‡§';
                if (currencyCode === 'USD') return 'ðŸ‡ºðŸ‡¸';
                if (currencyCode === 'JPY') return 'ðŸ‡¯ðŸ‡µ';
                if (currencyCode === 'CNY') return 'ðŸ‡¨ðŸ‡³';
                if (currencyCode === 'AUD') return 'ðŸ‡¦ðŸ‡º';
                if (currencyCode === 'CAD') return 'ðŸ‡¨ðŸ‡¦';
                if (currencyCode === 'CHF') return 'ðŸ‡¨ðŸ‡­';
                if (currencyCode === 'HKD') return 'ðŸ‡­ðŸ‡°';
                if (currencyCode === 'SGD') return 'ðŸ‡¸ðŸ‡¬';
                if (currencyCode === 'SEK') return 'ðŸ‡¸ðŸ‡ª';
                if (currencyCode === 'KRW') return 'ðŸ‡°ðŸ‡·';
                if (currencyCode === 'NOK') return 'ðŸ‡³ðŸ‡´';
                if (currencyCode === 'NZD') return 'ðŸ‡³ðŸ‡¿';
                if (currencyCode === 'INR') return 'ðŸ‡®ðŸ‡³';
                if (currencyCode === 'MXN') return 'ðŸ‡²ðŸ‡½';
                if (currencyCode === 'TWD') return 'ðŸ‡¹ðŸ‡¼';
                if (currencyCode === 'ZAR') return 'ðŸ‡¿ðŸ‡¦';
                if (currencyCode === 'BRL') return 'ðŸ‡§ðŸ‡·';
                if (currencyCode === 'DKK') return 'ðŸ‡©ðŸ‡°';
                return 'ðŸ³ï¸';
            }
        }
        
        // Get user from localStorage
        function getCurrentUser() {
            const userJSON = localStorage.getItem('user');
            if (!userJSON) return null;
            
            try {
                return JSON.parse(userJSON);
            } catch (error) {
                console.error('Error parsing user JSON:', error);
                return null;
            }
        }
        
        // Get access token from localStorage
        function getAccessToken() {
            return localStorage.getItem('access_token');
        }
        
        // Check if user is logged in
        function isLoggedIn() {
            return getAccessToken() && getCurrentUser();
        }
        
        // Render auth container based on login status
        function renderAuthUI() {
            if (isLoggedIn()) {
                const user = getCurrentUser();
                const initials = user.name.split(' ')
                    .map(n => n[0])
                    .join('')
                    .toUpperCase();
                
                authContainer.innerHTML = `
                    <div class="user-menu">
                        <button class="user-menu-btn" id="user-menu-btn">
                            <div class="user-avatar">${initials}</div>
                            <span style="display: inline-block !important; visibility: visible !important;">${user.name}</span>
                        </button>
                        <div class="user-dropdown" id="user-dropdown">
                            <a href="profile.html" class="user-dropdown-item profile">Profile</a>
                            <a href="preferences.html" class="user-dropdown-item preferences">Preferences</a>
                            <a href="#" class="user-dropdown-item logout">Logout</a>
                        </div>
                    </div>
                `;
                
                // Set up event listeners after a short delay to ensure elements are in the DOM
                setTimeout(() => {
                    const userMenuBtn = document.getElementById('user-menu-btn');
                    const userDropdown = document.getElementById('user-dropdown');
                    const logoutLink = document.querySelector('.user-dropdown-item.logout');
                    
                    if (userMenuBtn) {
                        userMenuBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            userDropdown.classList.toggle('show');
                        });
                    }
                    
                    // Close dropdown when clicking outside
                    document.addEventListener('click', (e) => {
                        if (userMenuBtn && userDropdown && !userMenuBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                            userDropdown.classList.remove('show');
                        }
                    });
                    
                    // Logout functionality
                    if (logoutLink) {
                        logoutLink.addEventListener('click', (e) => {
                            e.preventDefault();
                            logout();
                        });
                    }
                }, 100);
            } else {
                authContainer.innerHTML = `
                    <div class="auth-links">
                        <a href="auth.html" class="login">Login</a>
                        <a href="auth.html" class="register">Register</a>
                    </div>
                `;
            }
        }
        
        // Render user preferences UI
        function renderUserPreferences() {
            if (isLoggedIn()) {
                fetchUserPreferences()
                    .then(preferences => {
                        // Get currency preferences - ensure it's always an array
                        const currencyPrefs = preferences && preferences.saved_currency_pairs ? preferences.saved_currency_pairs : [];
                        
                        // Get translations for the current language
                        const storedPrefs = localStorage.getItem('userPreferences');
                        let translations = { 
                            savedPairs: 'Saved Currency Pairs',
                            saveCurrentPair: 'Save Current Pair',
                            useBtn: 'Use',
                            deleteBtn: 'Delete',
                            noSavedPairs: 'No saved currency pairs yet',
                            to: 'to'
                        };
                        
                        if (storedPrefs) {
                            try {
                                const prefs = JSON.parse(storedPrefs);
                                if (prefs.language) {
                                    // Get translations for the current language
                                    const langTranslations = getTranslations(prefs.language);
                                    if (langTranslations) {
                                        translations = {
                                            savedPairs: langTranslations.savedPairs || translations.savedPairs,
                                            saveCurrentPair: langTranslations.saveCurrentPair || translations.saveCurrentPair,
                                            useBtn: langTranslations.useBtn || translations.useBtn,
                                            deleteBtn: langTranslations.deleteBtn || translations.deleteBtn,
                                            noSavedPairs: langTranslations.noSavedPairs || translations.noSavedPairs,
                                            to: langTranslations.to || 'to'
                                        };
                                    }
                                }
                            } catch (e) {
                                console.error('Error parsing stored preferences:', e);
                            }
                        }
                        
                        userPreferencesContainer.innerHTML = `
                            <div class="user-preferences">
                                <div class="preference-heading">
                                    <h3>${translations.savedPairs}</h3>
                                    <button id="save-current-pair" class="save-preference-btn">${translations.saveCurrentPair}</button>
                                </div>
                                <ul class="preferences-list" id="preferences-list">
                                    ${currencyPrefs.length ? 
                                        currencyPrefs.map((pref, index) => `
                                            <li class="preference-item">
                                                <span>${getCurrencyFlag(pref.from)} ${pref.from} ${translations.to} ${getCurrencyFlag(pref.to)} ${pref.to}</span>
                                                <div>
                                                    <button data-index="${index}" class="use-pair-btn">${translations.useBtn}</button>
                                                    <button data-index="${index}" class="delete-pair-btn">${translations.deleteBtn}</button>
                                                </div>
                                            </li>
                                        `).join('') :
                                        `<li class="preference-item">${translations.noSavedPairs}</li>`
                                    }
                                </ul>
                            </div>
                        `;
                        
                        // Set up event listeners with a delay to ensure DOM is updated
                        setTimeout(() => {
                            // Save current pair button
                            const saveCurrentPairBtn = document.getElementById('save-current-pair');
                            if (saveCurrentPairBtn) {
                                // Remove any existing event listeners (to prevent duplicates)
                                const newSaveBtn = saveCurrentPairBtn.cloneNode(true);
                                saveCurrentPairBtn.parentNode.replaceChild(newSaveBtn, saveCurrentPairBtn);
                                newSaveBtn.addEventListener('click', saveCurrentPair);
                            }
                            
                            // Attach event listeners to use/delete buttons
                            document.querySelectorAll('.use-pair-btn').forEach(btn => {
                                btn.addEventListener('click', useCurrencyPair);
                            });
                            
                            document.querySelectorAll('.delete-pair-btn').forEach(btn => {
                                btn.addEventListener('click', deleteCurrencyPair);
                            });
                        }, 100);
                    })
                    .catch(error => {
                        console.error('Error fetching preferences:', error);
                        userPreferencesContainer.innerHTML = `
                            <div class="user-preferences">
                                <h3>Saved Currency Pairs</h3>
                                <p>Error loading preferences. Please try again later.</p>
                            </div>
                        `;
                    });
            } else {
                userPreferencesContainer.innerHTML = `
                    <div class="login-prompt">
                        <p>Login to save your favorite currency pairs and preferences</p>
                        <a href="auth.html">Login or Register</a>
                    </div>
                `;
            }
        }
        
        // Helper function to get translations for a specific language
        function getTranslations(language) {
            const translationKeys = {
                'en': {
                    'converterTitle': 'Currency Converter',
                    'enterAmount': 'Enter amount',
                    'convertBtn': 'Convert',
                    'savedPairs': 'Saved Currency Pairs',
                    'saveCurrentPair': 'Save Current Pair',
                    'loginPrompt': 'Login to save your favorite currency pairs and preferences',
                    'loginRegister': 'Login or Register',
                    'convertingMsg': 'Converting...',
                    'lastUpdated': 'Last updated',
                    'login': 'Login',
                    'register': 'Register',
                    'profile': 'Profile',
                    'preferences': 'Preferences',
                    'logout': 'Logout',
                    'noSavedPairs': 'No saved currency pairs yet',
                    'useBtn': 'Use',
                    'deleteBtn': 'Delete',
                    'to': 'to'
                },
                'ko': {
                    'converterTitle': 'í™˜ìœ¨ ë³€í™˜ê¸°',
                    'enterAmount': 'ê¸ˆì•¡ ìž…ë ¥',
                    'convertBtn': 'ë³€í™˜',
                    'savedPairs': 'ì €ìž¥ëœ í†µí™” ìŒ',
                    'saveCurrentPair': 'í˜„ìž¬ ìŒ ì €ìž¥',
                    'loginPrompt': 'ì¦ê²¨ì°¾ëŠ” í†µí™” ìŒê³¼ í™˜ê²½ì„¤ì •ì„ ì €ìž¥í•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”',
                    'loginRegister': 'ë¡œê·¸ì¸ ë˜ëŠ” ë“±ë¡',
                    'convertingMsg': 'ë³€í™˜ ì¤‘...',
                    'lastUpdated': 'ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸',
                    'login': 'ë¡œê·¸ì¸',
                    'register': 'ë“±ë¡',
                    'profile': 'í”„ë¡œí•„',
                    'preferences': 'í™˜ê²½ì„¤ì •',
                    'logout': 'ë¡œê·¸ì•„ì›ƒ',
                    'noSavedPairs': 'ì €ìž¥ëœ í†µí™” ìŒì´ ì—†ìŠµë‹ˆë‹¤',
                    'useBtn': 'ì‚¬ìš©',
                    'deleteBtn': 'ì‚­ì œ',
                    'to': 'ì—ì„œ'
                }
                // Other language translations remain...
            };
            
            return translationKeys[language] || translationKeys['en'];
        }
        
        // Fetch user preferences from API
        async function fetchUserPreferences() {
            const token = getAccessToken();
            if (!token) throw new Error('Not authenticated');
            
            try {
                const response = await fetch(`${AUTH_API_BASE_URL}/users/me/preferences`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch preferences');
                }
                
                return await response.json();
            } catch (error) {
                console.error('Error fetching preferences:', error);
                return { saved_currency_pairs: [] };
            }
        }
        
        // Save current currency pair
        async function saveCurrentPair() {
            const from = document.getElementById('from-currency').value;
            const to = document.getElementById('to-currency').value;
            
            try {
                // Check if the user is logged in
                if (!isLoggedIn()) {
                    alert('Please log in to save currency pairs.');
                    return;
                }
                
                // Get current preferences
                const preferences = await fetchUserPreferences().catch(error => {
                    console.error('Error fetching preferences:', error);
                    return { saved_currency_pairs: [] };
                });
                
                // Ensure we have a valid array
                let currencyPairs = Array.isArray(preferences.saved_currency_pairs) 
                    ? preferences.saved_currency_pairs 
                    : [];
                
                // Check if pair already exists
                const pairExists = currencyPairs.some(pair => 
                    pair.from === from && pair.to === to
                );
                
                if (pairExists) {
                    alert('This currency pair is already saved.');
                    return;
                }
                
                // Add new pair
                currencyPairs.push({ from, to });
                
                // Update preferences
                await updateUserPreferences({
                    saved_currency_pairs: currencyPairs
                });
                
                // Re-render preferences
                renderUserPreferences();
                
                // Show success message
                alert('Currency pair saved successfully!');
                
            } catch (error) {
                console.error('Error saving currency pair:', error);
                alert('Failed to save currency pair. Please try again.');
            }
        }
        
        // Update user preferences
        async function updateUserPreferences(preferences) {
            const token = getAccessToken();
            if (!token) throw new Error('Not authenticated');
            
            const response = await fetch(`${AUTH_API_BASE_URL}/users/me/preferences`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(preferences)
            });
            
            if (!response.ok) {
                throw new Error('Failed to update preferences');
            }
            
            return await response.json();
        }
        
        // Use a saved currency pair
        function useCurrencyPair(e) {
            const index = e.target.getAttribute('data-index');
            
            fetchUserPreferences()
                .then(preferences => {
                    const currencyPairs = preferences.saved_currency_pairs || [];
                    if (index < 0 || index >= currencyPairs.length) return;
                    
                    const pair = currencyPairs[index];
                    
                    // Update select inputs
                    document.getElementById('from-currency').value = pair.from;
                    document.getElementById('to-currency').value = pair.to;
                    
                    // Trigger exchange rate update
                    fetchExchangeRates();
                })
                .catch(error => {
                    console.error('Error using currency pair:', error);
                });
        }
        
        // Delete a saved currency pair
        async function deleteCurrencyPair(e) {
            const index = e.target.getAttribute('data-index');
            
            try {
                const preferences = await fetchUserPreferences();
                let currencyPairs = preferences.saved_currency_pairs || [];
                
                if (index < 0 || index >= currencyPairs.length) return;
                
                // Remove the pair
                currencyPairs.splice(index, 1);
                
                // Update preferences
                await updateUserPreferences({
                    saved_currency_pairs: currencyPairs
                });
                
                // Re-render preferences
                renderUserPreferences();
                
            } catch (error) {
                console.error('Error deleting currency pair:', error);
                alert('Failed to delete currency pair. Please try again.');
            }
        }
        
        // Logout function
        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user');
            window.location.reload();
        }
        
        // Init function
        function initAuth() {
            renderAuthUI();
            renderUserPreferences();
            applyStoredLanguagePreference();
        }
        
        // Apply stored language preference
        function applyStoredLanguagePreference() {
            // Get stored preferences
            const storedPrefs = localStorage.getItem('userPreferences');
            if (storedPrefs) {
                try {
                    const prefs = JSON.parse(storedPrefs);
                    if (prefs.language) {
                        document.documentElement.lang = prefs.language;
                        
                        // Comprehensive translations for all supported languages
                        const translationKeys = {
                            'en': {
                                'converterTitle': 'Currency Converter',
                                'enterAmount': 'Enter amount',
                                'convertBtn': 'Convert',
                                'savedPairs': 'Saved Currency Pairs',
                                'saveCurrentPair': 'Save Current Pair',
                                'loginPrompt': 'Login to save your favorite currency pairs and preferences',
                                'loginRegister': 'Login or Register',
                                'convertingMsg': 'Converting...',
                                'lastUpdated': 'Last updated',
                                'login': 'Login',
                                'register': 'Register',
                                'profile': 'Profile',
                                'preferences': 'Preferences',
                                'logout': 'Logout',
                                'noSavedPairs': 'No saved currency pairs yet',
                                'useBtn': 'Use',
                                'deleteBtn': 'Delete',
                                'to': 'to'
                            },
                            'es': {
                                'converterTitle': 'Conversor de Moneda',
                                'enterAmount': 'Ingrese cantidad',
                                'convertBtn': 'Convertir',
                                'savedPairs': 'Pares de Monedas Guardados',
                                'saveCurrentPair': 'Guardar Par Actual',
                                'loginPrompt': 'Inicie sesiÃ³n para guardar sus pares de monedas favoritos y preferencias',
                                'loginRegister': 'Iniciar sesiÃ³n o Registrarse',
                                'convertingMsg': 'Convirtiendo...',
                                'lastUpdated': 'Ãšltima actualizaciÃ³n',
                                'login': 'Iniciar sesiÃ³n',
                                'register': 'Registrarse',
                                'profile': 'Perfil',
                                'preferences': 'Preferencias',
                                'logout': 'Cerrar sesiÃ³n',
                                'noSavedPairs': 'AÃºn no hay pares de monedas guardados',
                                'useBtn': 'Usar',
                                'deleteBtn': 'Eliminar',
                                'to': 'a'
                            },
                            'fr': {
                                'converterTitle': 'Convertisseur de Devises',
                                'enterAmount': 'Entrez le montant',
                                'convertBtn': 'Convertir',
                                'savedPairs': 'Paires de Devises EnregistrÃ©es',
                                'saveCurrentPair': 'Enregistrer la Paire Actuelle',
                                'loginPrompt': 'Connectez-vous pour enregistrer vos paires de devises prÃ©fÃ©rÃ©es et vos prÃ©fÃ©rences',
                                'loginRegister': 'Connexion ou Inscription',
                                'convertingMsg': 'Conversion en cours...',
                                'lastUpdated': 'DerniÃ¨re mise Ã  jour',
                                'login': 'Connexion',
                                'register': 'Inscription',
                                'profile': 'Profil',
                                'preferences': 'PrÃ©fÃ©rences',
                                'logout': 'DÃ©connexion',
                                'noSavedPairs': 'Pas encore de paires de devises enregistrÃ©es',
                                'useBtn': 'Utiliser',
                                'deleteBtn': 'Supprimer',
                                'to': 'Ã '
                            },
                            'de': {
                                'converterTitle': 'WÃ¤hrungsrechner',
                                'enterAmount': 'Betrag eingeben',
                                'convertBtn': 'Umrechnen',
                                'savedPairs': 'Gespeicherte WÃ¤hrungspaare',
                                'saveCurrentPair': 'Aktuelles Paar speichern',
                                'loginPrompt': 'Melden Sie sich an, um Ihre LieblingswÃ¤hrungspaare und Einstellungen zu speichern',
                                'loginRegister': 'Anmelden oder Registrieren',
                                'convertingMsg': 'Umrechnung lÃ¤uft...',
                                'lastUpdated': 'Zuletzt aktualisiert',
                                'login': 'Anmelden',
                                'register': 'Registrieren',
                                'profile': 'Profil',
                                'preferences': 'Einstellungen',
                                'logout': 'Abmelden',
                                'noSavedPairs': 'Noch keine WÃ¤hrungspaare gespeichert',
                                'useBtn': 'Verwenden',
                                'deleteBtn': 'LÃ¶schen',
                                'to': 'zu'
                            },
                            'it': {
                                'converterTitle': 'Convertitore di Valuta',
                                'enterAmount': 'Inserisci importo',
                                'convertBtn': 'Converti',
                                'savedPairs': 'Coppie di Valute Salvate',
                                'saveCurrentPair': 'Salva Coppia Attuale',
                                'loginPrompt': 'Accedi per salvare le tue coppie di valute preferite e le preferenze',
                                'loginRegister': 'Accedi o Registrati',
                                'convertingMsg': 'Conversione in corso...',
                                'lastUpdated': 'Ultimo aggiornamento',
                                'login': 'Accedi',
                                'register': 'Registrati',
                                'profile': 'Profilo',
                                'preferences': 'Preferenze',
                                'logout': 'Esci',
                                'noSavedPairs': 'Nessuna coppia di valute salvata',
                                'useBtn': 'Usa',
                                'deleteBtn': 'Elimina',
                                'to': 'a'
                            },
                            'pt': {
                                'converterTitle': 'Conversor de Moeda',
                                'enterAmount': 'Insira o valor',
                                'convertBtn': 'Converter',
                                'savedPairs': 'Pares de Moedas Salvos',
                                'saveCurrentPair': 'Salvar Par Atual',
                                'loginPrompt': 'FaÃ§a login para salvar seus pares de moedas favoritos e preferÃªncias',
                                'loginRegister': 'Login ou Registro',
                                'convertingMsg': 'Convertendo...',
                                'lastUpdated': 'Ãšltima atualizaÃ§Ã£o',
                                'login': 'Entrar',
                                'register': 'Registrar',
                                'profile': 'Perfil',
                                'preferences': 'PreferÃªncias',
                                'logout': 'Sair',
                                'noSavedPairs': 'Ainda nÃ£o hÃ¡ pares de moedas salvos',
                                'useBtn': 'Usar',
                                'deleteBtn': 'Excluir',
                                'to': 'para'
                            },
                            'ja': {
                                'converterTitle': 'é€šè²¨ã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼',
                                'enterAmount': 'é‡‘é¡ã‚’å…¥åŠ›',
                                'convertBtn': 'å¤‰æ›',
                                'savedPairs': 'ä¿å­˜ã•ã‚ŒãŸé€šè²¨ãƒšã‚¢',
                                'saveCurrentPair': 'ç¾åœ¨ã®ãƒšã‚¢ã‚’ä¿å­˜',
                                'loginPrompt': 'ãŠæ°—ã«å…¥ã‚Šã®é€šè²¨ãƒšã‚¢ã¨è¨­å®šã‚’ä¿å­˜ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„',
                                'loginRegister': 'ãƒ­ã‚°ã‚¤ãƒ³ã¾ãŸã¯ç™»éŒ²',
                                'convertingMsg': 'å¤‰æ›ä¸­...',
                                'lastUpdated': 'æœ€çµ‚æ›´æ–°',
                                'login': 'ãƒ­ã‚°ã‚¤ãƒ³',
                                'register': 'ç™»éŒ²',
                                'profile': 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«',
                                'preferences': 'è¨­å®š',
                                'logout': 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ',
                                'noSavedPairs': 'ä¿å­˜ã•ã‚ŒãŸé€šè²¨ãƒšã‚¢ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“',
                                'useBtn': 'ä½¿ç”¨',
                                'deleteBtn': 'å‰Šé™¤',
                                'to': 'ã«'
                            },
                            'zh': {
                                'converterTitle': 'è´§å¸è½¬æ¢å™¨',
                                'enterAmount': 'è¾“å…¥é‡‘é¢',
                                'convertBtn': 'è½¬æ¢',
                                'savedPairs': 'å·²ä¿å­˜çš„è´§å¸å¯¹',
                                'saveCurrentPair': 'ä¿å­˜å½“å‰è´§å¸å¯¹',
                                'loginPrompt': 'ç™»å½•ä»¥ä¿å­˜æ‚¨å–œçˆ±çš„è´§å¸å¯¹å’Œåå¥½è®¾ç½®',
                                'loginRegister': 'ç™»å½•æˆ–æ³¨å†Œ',
                                'convertingMsg': 'è½¬æ¢ä¸­...',
                                'lastUpdated': 'æœ€åŽæ›´æ–°',
                                'login': 'ç™»å½•',
                                'register': 'æ³¨å†Œ',
                                'profile': 'ä¸ªäººèµ„æ–™',
                                'preferences': 'åå¥½è®¾ç½®',
                                'logout': 'é€€å‡ºç™»å½•',
                                'noSavedPairs': 'æš‚æ— å·²ä¿å­˜çš„è´§å¸å¯¹',
                                'useBtn': 'ä½¿ç”¨',
                                'deleteBtn': 'åˆ é™¤',
                                'to': 'åˆ°'
                            },
                            'ko': {
                                'converterTitle': 'í™˜ìœ¨ ë³€í™˜ê¸°',
                                'enterAmount': 'ê¸ˆì•¡ ìž…ë ¥',
                                'convertBtn': 'ë³€í™˜',
                                'savedPairs': 'ì €ìž¥ëœ í†µí™” ìŒ',
                                'saveCurrentPair': 'í˜„ìž¬ ìŒ ì €ìž¥',
                                'loginPrompt': 'ì¦ê²¨ì°¾ëŠ” í†µí™” ìŒê³¼ í™˜ê²½ì„¤ì •ì„ ì €ìž¥í•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”',
                                'loginRegister': 'ë¡œê·¸ì¸ ë˜ëŠ” ë“±ë¡',
                                'convertingMsg': 'ë³€í™˜ ì¤‘...',
                                'lastUpdated': 'ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸',
                                'login': 'ë¡œê·¸ì¸',
                                'register': 'ë“±ë¡',
                                'profile': 'í”„ë¡œí•„',
                                'preferences': 'í™˜ê²½ì„¤ì •',
                                'logout': 'ë¡œê·¸ì•„ì›ƒ',
                                'noSavedPairs': 'ì €ìž¥ëœ í†µí™” ìŒì´ ì—†ìŠµë‹ˆë‹¤',
                                'useBtn': 'ì‚¬ìš©',
                                'deleteBtn': 'ì‚­ì œ',
                                'to': 'ì—ì„œ'
                            }
                        };
                        
                        // Get translations for selected language or fallback to English
                        const translations = translationKeys[prefs.language] || translationKeys['en'];
                        
                        // Safely update text content with error handling
                        const safeUpdateText = (selector, text) => {
                            try {
                                const element = document.querySelector(selector);
                                if (element) {
                                    element.textContent = text;
                                }
                            } catch (err) {
                                console.warn(`Error updating ${selector}:`, err);
                            }
                        };
                        
                        const safeUpdateAttribute = (selector, attr, value) => {
                            try {
                                const element = document.getElementById(selector);
                                if (element) {
                                    element.setAttribute(attr, value);
                                }
                            } catch (err) {
                                console.warn(`Error updating ${selector} attribute:`, err);
                            }
                        };
                        
                        // Update text content based on language - with error handling
                        safeUpdateText('h1', translations.converterTitle);
                        safeUpdateAttribute('amount', 'placeholder', translations.enterAmount);
                        
                        // Update convert button if it exists
                        const convertBtn = document.getElementById('convert-btn');
                        if (convertBtn) {
                            convertBtn.textContent = translations.convertBtn;
                        }
                        
                        // Update loading message
                        const loadingMsg = document.querySelector('#loading-indicator p');
                        if (loadingMsg) {
                            loadingMsg.textContent = translations.convertingMsg;
                        }
                        
                        // Update "Last updated" text
                        const lastUpdatedElem = document.getElementById('last-updated');
                        if (lastUpdatedElem && lastUpdatedElem.textContent.startsWith('Last updated')) {
                            const timeStr = lastUpdatedElem.textContent.replace('Last updated:', '').trim();
                            lastUpdatedElem.textContent = `${translations.lastUpdated}: ${timeStr}`;
                        }
                        
                        // Update login/register links
                        const authLinks = document.querySelector('.auth-links');
                        if (authLinks) {
                            const loginLink = authLinks.querySelector('.login');
                            const registerLink = authLinks.querySelector('.register');
                            
                            if (loginLink) loginLink.textContent = translations.login;
                            if (registerLink) registerLink.textContent = translations.register;
                        }
                        
                        // Update user dropdown menu if logged in
                        const userDropdown = document.getElementById('user-dropdown');
                        if (userDropdown) {
                            const profileLink = userDropdown.querySelector('.profile');
                            const prefsLink = userDropdown.querySelector('.preferences');
                            const logoutLink = userDropdown.querySelector('.logout');
                            
                            if (profileLink) profileLink.textContent = translations.profile;
                            if (prefsLink) prefsLink.textContent = translations.preferences;
                            if (logoutLink) logoutLink.textContent = translations.logout;
                        }
                        
                        // Update currency pairs section if it exists
                        const savePairBtn = document.getElementById('save-current-pair');
                        if (savePairBtn) {
                            savePairBtn.textContent = translations.saveCurrentPair;
                            
                            // Update heading if it exists
                            const prefHeading = document.querySelector('.preference-heading h3');
                            if (prefHeading) {
                                prefHeading.textContent = translations.savedPairs;
                            }
                            
                            // Find all preference items and translate the "No saved pairs" text
                            const preferenceItems = document.querySelectorAll('.preference-item');
                            preferenceItems.forEach(item => {
                                if (item.textContent.includes('No saved currency pairs yet')) {
                                    item.textContent = translations.noSavedPairs;
                                }
                            });
                            
                            // Update use and delete buttons
                            document.querySelectorAll('.use-pair-btn').forEach(btn => {
                                btn.textContent = translations.useBtn;
                            });
                            
                            document.querySelectorAll('.delete-pair-btn').forEach(btn => {
                                btn.textContent = translations.deleteBtn;
                            });
                        }
                        
                        // Update login prompt
                        const loginPrompt = document.querySelector('.login-prompt');
                        if (loginPrompt) {
                            const promptText = loginPrompt.querySelector('p');
                            const promptLink = loginPrompt.querySelector('a');
                            
                            if (promptText) {
                                promptText.textContent = translations.loginPrompt;
                            }
                            
                            if (promptLink) {
                                promptLink.textContent = translations.loginRegister;
                            }
                        }
                        
                        // Also re-render the user preferences to ensure translations are applied
                        renderUserPreferences();
                    }
                } catch (e) {
                    console.error('Error parsing stored preferences:', e);
                }
            }
        }
        
        // Document ready
        document.addEventListener('DOMContentLoaded', () => {
            // Event listeners
            const convertBtn = document.getElementById('convert-btn');
            
            // Add handleConversion function if it doesn't exist
            if (typeof handleConversion !== 'function') {
                window.handleConversion = function() {
                    convertCurrency();
                };
            }
            
            if (convertBtn) {
                convertBtn.addEventListener('click', handleConversion);
            }
            
            const swapBtn = document.getElementById('swap-btn');
            if (swapBtn) {
                swapBtn.addEventListener('click', swapCurrencies);
            }
            
            // Add validateAmount function if it doesn't exist (referenced in the event listener)
            if (typeof validateAmount !== 'function') {
                window.validateAmount = function(e) {
                    const amount = parseFloat(e.target.value);
                    if (isNaN(amount) || amount <= 0) {
                        e.target.classList.add('invalid');
                    } else {
                        e.target.classList.remove('invalid');
                    }
                };
            }
            
            const amountInput = document.getElementById('amount');
            if (amountInput) {
                amountInput.addEventListener('input', validateAmount);
            }
            
            // Add event listeners for currency selects
            const fromCurrency = document.getElementById('from-currency');
            if (fromCurrency) {
                fromCurrency.addEventListener('change', fetchExchangeRates);
            }
            
            const toCurrency = document.getElementById('to-currency');
            if (toCurrency) {
                toCurrency.addEventListener('change', fetchExchangeRates);
            }
            
            // Initialize the currency options if the function exists
            if (typeof initCurrencyOptions === 'function') {
                initCurrencyOptions();
            }
            
            // Listen for preference changes
            window.addEventListener('userPreferencesChanged', (event) => {
                applyStoredLanguagePreference();
                renderUserPreferences();
                
                // If currency changed, update default currency
                const details = event.detail;
                if (details && details.currency) {
                    // Set the from-currency to the user's preferred currency
                    const fromCurrency = document.getElementById('from-currency');
                    if (fromCurrency && fromCurrency.value !== details.currency) {
                        fromCurrency.value = details.currency;
                        fetchExchangeRates();
                    }
                }
            });
            
            // Ensure save current pair button is functional
            setTimeout(() => {
                const saveCurrentPairBtn = document.getElementById('save-current-pair');
                if (saveCurrentPairBtn) {
                    console.log('Adding event listener to save-current-pair button');
                    saveCurrentPairBtn.addEventListener('click', saveCurrentPair);
                }
            }, 500);
            
            // Initialize
            initAuth();
            fetchExchangeRates();
            
            // Apply stored currency preference if available
            const storedPrefs = localStorage.getItem('userPreferences');
            if (storedPrefs) {
                try {
                    const prefs = JSON.parse(storedPrefs);
                    if (prefs.currency) {
                        const fromCurrencySelect = document.getElementById('from-currency');
                        if (fromCurrencySelect && fromCurrencySelect.value !== prefs.currency) {
                            fromCurrencySelect.value = prefs.currency;
                            fetchExchangeRates();
                        }
                    }
                } catch (e) {
                    console.error('Error parsing stored preferences:', e);
                }
            }
        });
    </script>
</body>
</html> 